name: Retry Failed Extractions

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  retry:
    runs-on: ubuntu-latest
    timeout-minutes: 350  # 5.5 hours max
    
    concurrency:
      group: retry-${{ github.ref }}
      cancel-in-progress: false
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Setup Google Chrome
        id: setup-chrome
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: stable
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          echo "Chrome binary: ${{ steps.setup-chrome.outputs.chrome-path }}"
      
      - name: Run retry script with auto-checkpoint
        env:
          CHROME_BIN: ${{ steps.setup-chrome.outputs.chrome-path }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Run script in background
          python retry_failures.py &
          PID=$!
          
          # Commit checkpoint every 2 minutes while script runs
          while kill -0 $PID 2>/dev/null; do
            sleep 120  # 2 minutes
            
            git add retry_checkpoint.txt retry_results.json 2>/dev/null || true
            if ! git diff --staged --quiet 2>/dev/null; then
              CHECKPOINT=$(cat retry_checkpoint.txt 2>/dev/null || echo "0")
              git commit -m "Checkpoint: $CHECKPOINT URLs processed" || true
              git push || (git pull --rebase && git push) || true
              echo "‚úÖ Checkpoint saved: $CHECKPOINT"
            fi
          done
          
          # Wait for script to finish
          wait $PID
      
      - name: Final commit and push
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add retry_checkpoint.txt retry_results.json 2>/dev/null || true
          
          if ! git diff --staged --quiet 2>/dev/null; then
            CHECKPOINT=$(cat retry_checkpoint.txt 2>/dev/null || echo "0")
            git commit -m "Final checkpoint: $CHECKPOINT URLs - $(date +'%Y-%m-%d %H:%M:%S')" || true
            
            for i in {1..5}; do
              if git push; then
                echo "‚úÖ Final push successful"
                break
              else
                echo "‚ö†Ô∏è  Push failed, attempt $i/5"
                git pull --rebase
                sleep 5
              fi
            done
          else
            echo "‚úÖ No new changes to commit"
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "=" 
          echo "üìä FINAL SUMMARY"
          echo "="
          if [ -f "retry_checkpoint.txt" ]; then
            CHECKPOINT=$(cat retry_checkpoint.txt)
            echo "‚úÖ Checkpoint: $CHECKPOINT URLs processed"
          fi
          if [ -f "retry_results.json" ]; then
            RESULTS=$(python -c "import json; f=open('retry_results.json'); d=json.load(f); print(len(d)); f.close()")
            echo "üìù Total results saved: $RESULTS"
          fi
          TOTAL=$(wc -l < failed_urls_all_accounts.txt | tr -d ' ')
          echo "üìä Total URLs to process: $TOTAL"
          if [ -f "retry_checkpoint.txt" ]; then
            REMAINING=$((TOTAL - CHECKPOINT))
            echo "‚è≥ Remaining: $REMAINING"
          fi


