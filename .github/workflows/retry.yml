name: Retry Failed Extractions

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  retry:
    runs-on: ubuntu-latest
    timeout-minutes: 350  # 5.5 hours max
    
    concurrency:
      group: retry-${{ github.ref }}
      cancel-in-progress: false
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Setup Google Chrome
        id: setup-chrome
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: stable
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          echo "Chrome binary: ${{ steps.setup-chrome.outputs.chrome-path }}"
      
      - name: Run retry script with periodic commits
        env:
          CHROME_BIN: ${{ steps.setup-chrome.outputs.chrome-path }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Run script in background
          python retry_failures.py &
          PID=$!
          
          # Commit results every 5 minutes while script runs
          while kill -0 $PID 2>/dev/null; do
            sleep 300  # 5 minutes
            
            if [ -f "retry_results.json" ]; then
              git add retry_results.json
              if ! git diff --staged --quiet; then
                git commit -m "Checkpoint retry results - $(date +'%Y-%m-%d %H:%M:%S')" || true
                git push || (git pull --rebase && git push) || true
                echo "‚úÖ Checkpoint saved at $(date)"
              fi
            fi
          done
          
          # Wait for script to finish
          wait $PID
      
      - name: Final commit and push
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -f "retry_results.json" ]; then
            git add retry_results.json
            
            if ! git diff --staged --quiet; then
              git commit -m "Final retry results - $(date +'%Y-%m-%d %H:%M:%S')" || true
              
              for i in {1..5}; do
                if git push; then
                  echo "‚úÖ Final push successful"
                  break
                else
                  echo "‚ö†Ô∏è  Push failed, attempt $i/5"
                  git pull --rebase
                  sleep 5
                fi
              done
            else
              echo "‚úÖ No new changes to commit"
            fi
          else
            echo "‚ö†Ô∏è  No results file found"
          fi
      
      - name: Summary
        if: always()
        run: |
          if [ -f "retry_results.json" ]; then
            RESULTS=$(python -c "import json; f=open('retry_results.json'); d=json.load(f); print(len(d)); f.close()")
            echo "üìä Total results processed: $RESULTS"
          else
            echo "‚ö†Ô∏è  No results file found"
          fi


